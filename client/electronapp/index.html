<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>ChatCLI</title>
    <style>
      body {
        font-family: sans-serif;
        margin: 20px;
      }
      #result {
        margin-top: 20px;
        white-space: pre-wrap;
        background: #f7f7f7;
        padding: 10px;
        border: 1px solid #ddd;
      }
      .error {
        color: red;
      }
      .success {
        color: green;
      }
      #auth {
        margin-top: 20px;
      }
      form {
        display: flex;
        flex-direction: column;
        max-width: 300px;
      }
      form label {
        margin-top: 10px;
        font-weight: bold;
      }
      form input {
        padding: 8px;
        margin-top: 4px;
        font-size: 1rem;
      }
      form button {
        margin-top: 20px;
        padding: 10px;
        font-size: 1rem;
      }
      .link {
        margin-top: 12px;
        font-size: 0.9rem;
        color: blue;
        cursor: pointer;
        text-decoration: underline;
        background: none;
        border: none;
        padding: 0;
      }
    </style>
  </head>
  <body>
    <!-- Step 1: “Verifying connection…” by default -->
    <div id="result" class="success">Verifying connection…</div>

    <!-- Step 2: Hidden “auth” container, revealed on successful verification -->
    <div id="auth" style="display: none;">
      <h2>Welcome to ChatCLI</h2>
      <button id="loginBtn">Login</button>
      <button id="registerBtn">Register</button>
    </div>

    <script>
      window.addEventListener('DOMContentLoaded', () => {
        const resultDiv = document.getElementById('result');
        const authDiv = document.getElementById('auth');

        function showResult(message, isError = false) {
          resultDiv.innerText = message;
          resultDiv.classList.toggle('error', isError);
          resultDiv.classList.toggle('success', !isError);
        }

        function clearResult() {
          resultDiv.innerText = '';
          resultDiv.classList.remove('error', 'success');
        }

        // Helper: parse response as JSON if content-type is “application/json”,
        // otherwise return raw text.
        async function parseResponse(res) {
          const contentType = res.headers.get('content-type') || '';
          if (contentType.includes('application/json')) {
            return await res.json();
          } else {
            return await res.text();
          }
        }

        function attemptVerify() {
          fetch('http://localhost:5123/verify-connection', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ version: 'electron_app' })
          })
            .then(async (res) => {
              const body = await parseResponse(res);
              if (!res.ok) {
                // If body is an object (JSON), try to grab a “message” field
                const errMsg = typeof body === 'object'
                  ? (body.message || JSON.stringify(body))
                  : body;
                throw new Error(errMsg);
              }
              // Success: clear “Verifying…” and reveal Login/Register
              clearResult();
              authDiv.style.display = 'block';
            })
            .catch(err => {
              showResult('Connection failed: ' + err.message, true);
              setTimeout(attemptVerify, 5000);
            });
        }

        // Kick off first verify
        attemptVerify();

        // After verify succeeds, these appear:
        const loginBtn = document.getElementById('loginBtn');
        const registerBtn = document.getElementById('registerBtn');

        // ── LOGIN FORM ──────────────────────────────────────────────────────────────
        function showLoginForm() {
          clearResult();
          authDiv.innerHTML = `
            <h2>Login to ChatCLI</h2>
            <form id="loginForm">
              <label for="loginUsername">Username</label>
              <input id="loginUsername" type="text" required />

              <label for="loginPassword">Password</label>
              <input id="loginPassword" type="password" required />

              <button type="submit">Login</button>

              <button type="button" class="link" id="resetPwdLink">
                Reset password
              </button>

              <button type="button" class="link" id="gotoRegisterLink">
                Don't have an account? Register
              </button>
            </form>
          `;

          document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            clearResult();

            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            if (!username || !password) {
              showResult('Both fields are required.', true);
              return;
            }

            try {
              const res = await fetch('http://localhost:5123/user/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
              });
              const body = await parseResponse(res);
              if (!res.ok) {
                // body might be JSON or text
                const errMsg = typeof body === 'object'
                  ? (body.message || JSON.stringify(body))
                  : body;
                throw new Error(errMsg);
              }
              // Success
              showResult(body.message || 'Login successful.');
              // If a session_token is in “additional”, store it:
              if (Array.isArray(body.additional) && body.additional[0] === 'session_token') {
                const sessionToken = body.additional[1];
                console.log('Session token:', sessionToken);
                // TODO: persist sessionToken (e.g. localStorage or IPC to main) for future calls
              }
            } catch (err) {
              showResult('Login failed: ' + err.message, true);
            }
          });

          document.getElementById('resetPwdLink').addEventListener('click', () => {
            showResetPasswordRequestForm();
          });
          document.getElementById('gotoRegisterLink').addEventListener('click', () => {
            showRegisterForm();
          });
        }

        // ── REGISTER FORM ────────────────────────────────────────────────────────────
        function showRegisterForm() {
          clearResult();
          authDiv.innerHTML = `
            <h2>Register for ChatCLI</h2>
            <form id="registerForm">
              <label for="regEmail">Email</label>
              <input id="regEmail" type="email" required />

              <label for="regUsername">Username</label>
              <input id="regUsername" type="text" required />

              <label for="regPassword">Password</label>
              <input id="regPassword" type="password" required />

              <label for="regPasswordRepeat">Repeat Password</label>
              <input id="regPasswordRepeat" type="password" required />

              <button type="submit">Register</button>

              <button type="button" class="link" id="gotoLoginLink">
                Already have an account? Login
              </button>
            </form>
          `;

          document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            clearResult();

            const email = document.getElementById('regEmail').value.trim();
            const username = document.getElementById('regUsername').value.trim().toLowerCase();
            const password = document.getElementById('regPassword').value;
            const passwordRepeat = document.getElementById('regPasswordRepeat').value;

            // Basic client‐side validation
            if (!email || !username || !password || !passwordRepeat) {
              showResult('All fields are required.', true);
              return;
            }
            if (password !== passwordRepeat) {
              showResult('Passwords do not match.', true);
              return;
            }

            try {
              const res = await fetch('http://localhost:5123/user/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, username, password })
              });
              const body = await parseResponse(res);
              if (!res.ok) {
                const errMsg = typeof body === 'object'
                  ? (body.message || JSON.stringify(body))
                  : body;
                throw new Error(errMsg);
              }
              // Registration succeeded
              showResult(
                body.message ||
                  'Registration successful. Check your email for a verification code.',
                false
              );
              // Show the verify‐email form
              showVerifyEmailForm(username);
            } catch (err) {
              showResult('Registration failed: ' + err.message, true);
            }
          });

          document.getElementById('gotoLoginLink').addEventListener('click', () => {
            showLoginForm();
          });
        }

        // ── VERIFY EMAIL FORM ────────────────────────────────────────────────────────
        function showVerifyEmailForm(username) {
          authDiv.innerHTML = `
            <h2>Verify Your Email</h2>
            <p>A verification code has been sent to your email. Enter it below:</p>
            <form id="verifyEmailForm">
              <input type="hidden" id="verifyUsername" value="${username}" />
              <label for="emailToken">Verification Code</label>
              <input id="emailToken" type="text" required />

              <button type="submit">Verify Email</button>
            </form>
            <button type="button" class="link" id="gotoLoginLink2">
              Already verified? Go to Login
            </button>
          `;

          document.getElementById('verifyEmailForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            clearResult();

            const emailToken = document.getElementById('emailToken').value.trim();
            const user = document.getElementById('verifyUsername').value;

            if (!emailToken) {
              showResult('Verification code is required.', true);
              return;
            }

            try {
              const res = await fetch('http://localhost:5123/user/verify-email', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: user, email_token: emailToken })
              });
              const body = await parseResponse(res);
              if (!res.ok) {
                const errMsg = typeof body === 'object'
                  ? (body.message || JSON.stringify(body))
                  : body;
                throw new Error(errMsg);
              }
              showResult(body.message || 'Email verified! You can now log in.', false);
              setTimeout(showLoginForm, 1500);
            } catch (err) {
              showResult('Verification failed: ' + err.message, true);
            }
          });

          document.getElementById('gotoLoginLink2').addEventListener('click', () => {
            showLoginForm();
          });
        }

        // ── RESET PASSWORD REQUEST FORM ─────────────────────────────────────────────
        function showResetPasswordRequestForm() {
          clearResult();
          authDiv.innerHTML = `
            <h2>Reset Password</h2>
            <form id="resetReqForm">
              <label for="resetData">Username or Email</label>
              <input id="resetData" type="text" required />

              <button type="submit">Request Password Reset</button>
            </form>
            <button type="button" class="link" id="gotoLoginLink3">
              Back to Login
            </button>
          `;

          document.getElementById('resetReqForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            clearResult();

            const dataField = document.getElementById('resetData').value.trim();
            if (!dataField) {
              showResult('Enter your username or email.', true);
              return;
            }

            try {
              const res = await fetch('http://localhost:5123/user/reset-password-request', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ data: dataField })
              });
              const body = await parseResponse(res);
              if (!res.ok) {
                const errMsg = typeof body === 'object'
                  ? (body.message || JSON.stringify(body))
                  : body;
                throw new Error(errMsg);
              }
              showResult(body.message || 'Password reset email sent—check your inbox.', false);
            } catch (err) {
              showResult('Request failed: ' + err.message, true);
            }
          });

          document.getElementById('gotoLoginLink3').addEventListener('click', () => {
            showLoginForm();
          });
        }

        // Attach event listeners to initial buttons
        loginBtn.addEventListener('click', showLoginForm);
        registerBtn.addEventListener('click', showRegisterForm);
      });
    </script>
  </body>
</html>
